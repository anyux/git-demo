官方提供很规范的代码模板，新插件的是在模板的基础上进行改写

默认情况下插件案例放在当前系统环境Python安装路径下的`site-packages/ansible/plugins/`目录下

其次编辑ansible.cfg定义插件存放目录，默认配置如下

ansible.cfg中在默认定义的插件目录下编写自己的插件

```ini
action_plugins = /usr/share/ansible_plugins/action_plugins
callback_plugins = /usr/share/ansible_plugins/callback_plugins
connection_plugins = /usr/share/ansible_plugins/connection_plugins
lookup_plugins = /usr/share/ansible_plugins/lookup_plugins
vars_plugins = /usr/share/ansible_plugins/vars_plugins
filter_plugins = /usr/share/ansible_plugins/filter_plugins
strategy_plugins = /usr/share/ansible_plugins/strategy_plugins
```

### 插件安全实践
官网对于插件的介绍并不多,只需要学习一些比较重要的如Filters,Callbacks
插件

#### lookup 插件使用
用于将文件内容读取到变量中并在剧本中使用
`lookup`是一个 Ansible 的 lookup 插件，用于读取文件内容
`filename`是文件的路径或名称,
```yaml
set_fact:
  data: "{{ lookup('file', 'filename') }}"
```

```yaml
---
- hosts: ubuntu
  gather_facts: yes
  tasks:
    - name: get content from /etc/hosts
      set_fact:
        data: "{{ lookup('file', '/etc/hosts') }}"
    - name: Display the vars data
      debug:
        msg: "{{ data.split('\n') }}"
```

```bash
ansible-playbook playbook.yaml

PLAY [ubuntu] *****

TASK [Gathering Facts] *****
ok: [192.168.255.110]

TASK [get content from /etc/hosts] *****
ok: [192.168.255.110]

TASK [Display the vars data] *****
ok: [192.168.255.110] => {
    "msg": [
        "127.0.0.1 localhost",
        "127.0.1.1 test",
        "",
        "# The following lines are desirable for IPv6 capable hosts",
        "::1     ip6-localhost ip6-loopback",
        "fe00::0 ip6-localnet",
        "ff00::0 ip6-mcastprefix",
        "ff02::1 ip6-allnodes",
        "ff02::2 ip6-allrouters"
    ]
}

PLAY RECAP *****
192.168.255.110            : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

```

```yaml
---
- hosts: ubuntu
  gather_facts: yes
  vars:
    my_list: [1,2,3,99,33,66,88]
  tasks:
    - name: print max value from mylist
      debug:
        msg: "{{ my_list | max  }}"
    - name: print min value from mylist
      debug:
        msg: "{{ my_list | min  }}"
```

```bash
TASK [print max value from mylist] *******
ok: [192.168.255.110] => {
    "msg": "99"
}

TASK [print min value from mylist] *******
ok: [192.168.255.110] => {
    "msg": "1"
}

```

<p style="background-color: rgba(0, 128, 0, 1); color: rgba(255, 255, 255, 1)">from_json 过滤器用于将字符串形式的 JSON 数据转换为 Ansible 可以处理的原生数据结构(例如字典或列表)</p>



```yaml
---
- hosts: ubuntu
  gather_facts: no
  vars:
    json_string: '{"name": "John", "age": 30, "city": "New York"}'
  tasks:
    - name: Convert JSON string to a dictionary
      set_fact:
        my_data: "{{ json_string | from_json }}"

    - name: Display the converted data
      debug:
        msg: "{{ my_data }}"
```

```bash
ansible-playbook playbook.yaml

PLAY [ubuntu] ********

TASK [Convert JSON string to a dictionary] ********
ok: [192.168.255.110]

TASK [Display the converted data] ********
ok: [192.168.255.110] => {
    "msg": {
        "age": 30,
        "city": "New York",
        "name": "John"
    }
}

PLAY RECAP ********
192.168.255.110            : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  
```
<p style="background-color: rgba(0, 128, 0, 1); color: rgba(255, 255, 255, 1)">to_json 过滤器将数据转换为 JSON 字符串</p>

```yaml
---
- hosts: ubuntu
  gather_facts: no
  vars:
    my_dict:
      name: John
      age: 30
      city: New York
  tasks:
    - name: Convert dict to a json_string
      set_fact:
        json_string: "{{ my_dict | to_json }}"

    - name: Display the json_string
      debug:
        msg: "{{ json_string }}"

```

```bash
ansible-playbook playbook.yaml

PLAY [ubuntu] *******

TASK [Convert dict to a json_string] *******
ok: [192.168.255.110]

TASK [Display the json_string] *******
ok: [192.168.255.110] => {
    "msg": {
        "age": 30,
        "city": "New York",
        "name": "John"
    }
}

PLAY RECAP *******
192.168.255.110            : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

to_json：将 Ansible 的原生数据结构（如字典或列表）转换为 JSON 格式的字符串.通常，你会使用它来序列化数据，以便将其存储、传输或记录为 JSON 格式的文本

from_json：将 JSON 格式的字符串解析为 Ansible 的原生数据结构(如字典或列表)。你会使用它来反序列化 JSON 字符串，以便在 playbook 中进一步处理

使用 debug 模块打印数据,无论是`to_json`或`from_json`处理后的数据,最终的输出都可能相似.这是因为debug模块显示数据内容,而json字符串和原生数据结构的内容在某些情况下是一样的

过滤器主要的作用是处理数据的序列化和反序列化,而不是改变数据的内容

### 自定义插件
ansible.cfg,开启自定义插件过滤器
filter_plugin 用于指定自定义过滤器的配置文件路径
```ini
filter_plugin = /usr/share/ansible/plugins/filter

```
```bash
mkdir /usr/share/ansible/plugins/filter -p
```
创建自定义过滤器文件,在/usr/share/ansible/plugins/filter目录下创建一个yaml文件,用于自定义过滤器,该文件内容可以是python代码

```yaml
filter_plugins:
  my_custom_filters:
    filter_one: |
      def filter_one(value):
          # 自定义过滤器逻辑
          return value.upper()

    filter_two: |
      def filter_two(value):
          # 另一个自定义过滤器逻辑
          return value[::-1]

```
